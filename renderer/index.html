<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport"
    content="width=device-width, user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1, viewport-fit=cover">
  <meta name="renderer" content="webkit">
  <meta name="description" content="PDF合成器，可以指定页数，调整顺利" />
  <meta name="keywords" content="pdf, office, 办公, 工具, 合成, 效能工具, 合成器" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>PDF合成器 - BruceCham</title>
  <link rel="stylesheet" href="../assets/lib/element-ui-2.14.0.min.css">
  <script src="../assets/lib/vue-2.6.12.min.js"></script>
  <script src="../assets/lib/element-ui-2.14.0.min.js"></script>
  <style>
    * {
      padding: 0;
      margin: 0;
      box-sizing: border-box;
    }
    body,
    html {
      width: 100%;
      height: 100%;
    }

    #app {
      padding: 25px;
      height: 100%;
    }
  
    section {
      width: 100%;
      height: 100%;
      max-width: 1200px;
      margin: 0px auto;
      border-radius: 10px;
      box-shadow: 0px 2px 8px 0px rgb(173 180 190 / 24%);
      transition: box-shadow 0.3s ease-out;
      border: 1px solid #ebebeb;
      background-color: #ffffff;
    }

    .upload-box {
      padding: 24px;
    }
  </style>
</head>

<body>
  <div id="app">
    <section>
      <div class="upload-box">
        <el-button style="margin-bottom: 15px;" :disabled="fileList.length === 0" type="primary" @click="submitUpload">开始合成PDF
        </el-button>
        <el-upload drag action="/" multiple accept="application/pdf"
          :auto-upload="false" :file-list="fileList" :before-remove="beforeRemove" :on-remove="handleChange" :on-change="handleChange">
          <i class="el-icon-upload"></i>
          <div class="el-upload__text">将文件拖到此处，或<em>点击上传</em></div>
          <div class="el-upload__tip" slot="tip">只能上传PDF文件，文件不宜过多过大</div>
        </el-upload>
      </div>
    </section>

  </div>
  <script>
    const { ipcRenderer } = require('electron');
    const fs = require('fs');
    const PDFMerger = require('pdf-merger-js/browser');
    new Vue({
      el: '#app',
      data: function () {
        return {
          fileList: []
        }
      },
      mounted() {
        ipcRenderer.on('download-message', (event, arg) => {
          if (arg === 'completed') {
            this.$message.success('文件下载成功！');
          } else {
            this.$message.success('文件下载失败！');
          }
        });
      },
      beforeDestroy() {
        ipcRenderer.removeListener('download-message')
      },
      methods: {
        handleChange(file, fileList) {
          this.fileList = fileList;
        },
        beforeRemove(file, fileList) {
          return this.$confirm(`确定移除 ${file.name}？`);
        },
        async submitUpload(filename) {
          const merger = new PDFMerger();
          const loading = this.$loading({
            lock: true,
            text: '合成中',
            spinner: 'el-icon-loading',
            background: 'rgba(0, 0, 0, 0.7)'
          });
          await Promise.all(this.fileList.map(async (file) => await merger.add(file.raw)));
          try {
            const mergedPdf = await merger.saveAsBlob();
            const url = URL.createObjectURL(mergedPdf);
            loading.close();
            this.download(url, '下载.pdf');
          } catch (err) {
            loading.close();
            const message = '合成出错：' + JSON.stringify(err);
            console.error(message);
            this.$message.error(message);
          }
        },
        download(url, filename) {
          const a = document.createElement("a");
          a.download = filename
          a.href = url;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
        }
      }
    })
  </script>
</body>

</html>